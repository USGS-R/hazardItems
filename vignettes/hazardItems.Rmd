---
title: "Hazard Items Workflow"
author: "Jordan Read, Jordan Walker, Luke Winslow, Megan Hines"
date: "`r format(Sys.time(), '%d %B, %Y')`"
output: 
  rmarkdown::html_vignette:
    toc: true
vignette: >
  %\VignetteEngine{knitr::rmarkdown}
  %\VignetteIndexEntry{Hazard Items Introduction}
  \usepackage[utf8]{inputenc}
---


```{r setup, include=FALSE}
library(rmarkdown)
options(continue=" ")
options(width=60)
library(knitr)
library(hazardItems)

```


#Introduction


This package **hazardItems** provides services in support of coastal change hazards items for the Coastal Change Hazards Portal at <a href="http://marine.usgs.gov/coastalchangehazardsportal" target="_blank">marine.usgs.gov/coastalchangehazardsportal</a>.  
    
`historical.service`, `storm.service` and `vulnerability.service` parse metadata records and create summaries specific to their respective themes. The subtypes are defined by the attribute names.

`thumb.service` expects an input json.url and returns a thumbnail png for the item.

`refreshItemThumbnail` creates a new thumbnail PNG for the requested item ID and puts it to the user specified endpoint.

`addLayer` service creates a new item from a zipped shapefile from an authenticated user.

`template` service creates or replaces new child items based on an input id. 

`setBaseURL` is a supporting function for directing requests and posts to the proper development, testing or production tier 

`authenticateUser` authenticates user against the current specified endpoint, and `checkAuth` verifies if the user is still authenticated

`checkItemExists` is a supporting function that accepts an item ID and returns TRUE or FALSE depending on if the item exists on the currently specified tier/endpoint.

#Installation
To install **hazardItems** 

Install package with dependencies:
```{r, eval=FALSE}
install.packages("hazardItems", 
    repos = c("https://owi.usgs.gov/R"),
    dependencies = TRUE)
```

#Item Metadata Packages

##Historical Metadata
`historical.service` parses the metadata record and creates a summary specific to the HISTORICAL theme, with subtype being defined by the attribute name. For example, to create a historical item from a local shapefile metadata file called NewJerseyS_shorelines.shp.xml and create a subtype named 'date':

```{r, results='hide'}
serviceEndpoint  <-  system.file('extdata',
"NewJerseyS_shorelines.shp.xml", package = 'hazardItems')
attribute	<-	'date'
summary	<-	historical.service(serviceEndpoint,attribute)
print(summary)
sink('output.json')
cat(summary)
sink()
```

##Storm Service Metadata
`storm.service` parses the metadata record and creates a summary specific to the STORM theme, with a subtype being defined by the attribute name. For example, to create a storm item from a remote url with an attribute named 'PCOL3':

```{r, results='hide'}
serviceEndpoint  <-  'http://olga.er.usgs.gov/data/NACCH/GOM_erosion_hazards_metadata.xml'
attribute	<-	'PCOL3'
summary	<-	storm.service(serviceEndpoint,attribute)
print(summary)
```

##Vulnerability Service Metadata
`vulnerability.service` parses the metadata record and creates a summary specific to the VULNERABILITY theme, with subtype being defined by the attribute name. The serviceEndpoint can be any valid xml file, either locally hosted or at a remote URL. For example, to create a vulnerability item from a local shapefile metadata file called `CVI_Pacific.shp.xml` and create an attribute named `SEA_LEVEL`:

```{r, results='hide'}
serviceEndpoint  <-  system.file('extdata',
"CVI_Pacific.shp.xml", package = 'hazardItems')
attribute  <-	'SEA_LEVEL'
summary	<-	vulnerability.service(serviceEndpoint,attribute)
print(summary)
```


##Real Time Storm Item Creation
Creating an item for a real-time storms event requires first establishing a parent aggregation item that will hold any number of child items beneath it. The parent item represents the storm. For example, "Hurricane Sandy" could be the title of a parent aggregation item for a real-time storm. 

<br />
<br />
An example workflow for adding or updating a real time storm would involve the following:


(@) a new `template` item is added from the <a href="https://cida.usgs.gov/coastalchangehazardsportal/publish/item/" target="_blank">mediation page</a> describing the incoming storm (manually performed by NACCH administrators</a>)

(@) the NACCH administrators note the new template item's itemId (usually a 7-9 character string)

(@) a model is run at St. Pete's producing a shapefile

(@) the shapefile contents are zipped including the XML metadata (shp, prj, xml, dbf, etc) - DO NOT NEST FILES IN A FOLDER

(@) the user calls `publishStorm CAQw7M1 D:\Sandy.zip` from command line with parameters for templateId and shapefile path 

-- every time the model is updated, follow steps 3 to 5


##Advanced User Real Time Storm Item Creation

An example workflow for a *new* incoming storm would involve the following:

* a new `template` item is added from the <a href="https://cida.usgs.gov/coastalchangehazardsportal/publish/item/" target="_blank">mediation page</a> describing the incoming storm (manually performed by NACCH administrators)

* the NACCH administrators note the new template item's itemId (usually a 7-9 character string)

* a model is run at St. Pete's producing a shapefile

* the shapefile contents are zipped including the XML metadata (shp, prj, xml, dbf, etc) - DO NOT NEST FILES IN A FOLDER

* the user loads the R package `hazardItems` into their local R environment

* the `addLayer` function is called to post the zipped file to the portal. If `addLayer` is successful, the layerId will be returned

* the `getLayer` function is called with the argument `field = "attrs"`. This will return all possible attributes that can be used to create item children.

* the `template` function is called to create specified items with the contents of the new layer

* the NACCH administrator manually attaches the template item to the top level (uber item) through the <a href="https://cida.usgs.gov/coastalchangehazardsportal/publish/item/" target="_blank">mediation page</a>.



```{r,eval=FALSE}
library(hazardItems)
setBaseURL("dev") #setBaseURL("prod") in the event of actual storm.
templateId = "CAQw7M1"
shapefile = "C:\\Users\\mhines\\documents\\Sandy_CIDA.zip" #enter full path to your zipped shapefile here
layerId = addLayer(shapefile)
attrs = getLayer(layerId, field = "attrs")
#enter more details here#
template(templateId,layerId,attrs)

```

#Rendering
##Thumbnail Generation 

The `thumb.service` accepts a json URL and creates a handsome thumbnail preview of the layer. For the CCH Portal, the thumbnails are used on the <a href="http://marine.usgs.gov/coastalchangehazardsportal/publish/item/">mediation page</a> as an item preview, in your bucket and in the search results panel.

To use:
```{r,eval=FALSE}
serviceEndpoint <- 'http://marine.usgs.gov/coastalchangehazardsportal/data/item/CAkR645'
thumb.service(serviceEndpoint)
```


#Refresh/delete of various caches

There are a number of functions that are required in order to clear out cached contents when items change. 

##Delete Entire Application Tile Cache

The `deleteTileCache` function takes the cache URL set by `pkg.env$tile_cache` and drops the entire tile cache for the application. The user must be authenticated to perform this task. 

To use:
```{r,eval=FALSE}
setBaseURL('dev') #setBaseURL("prod") in the event of production use.
tileCacheUrl <- pkg.env$tile_cache
deleteTileCache(username='bbadger') #replace the user making the request, if not authenticated, the checkAuth function will be called
```

##Delete Download Cache 

The `deleteDownload' function accepts the itemID for an item and drops the cached download for the item. The user must be authenticated to perform this task.

To use:
```{r,eval=FALSE}
setBaseURL('dev') #setBaseURL("prod") in the event of production use.
authenticateUser("bbadger")
deleteDownload("CCNKrhr") #itemID you wish to delete the download cache for
```

##Thumbnail Refresh

The `refreshItemThumbnail` accepts an item ID and will verify that the item exists, before putting a newly created thumbnail in the database.

To use:
```{r,eval=FALSE}
setBaseURL('dev') #setBaseURL("prod") in the event of production use.
refreshItemThumbnail('CCGftiy') #or whichever itemID you wish to regenerate and put
```

##Refreshing/deleting items and aggregations - Example Workflow

The workflow for changing an item or aggregation and needing to refresh the various caches/downloads/bits includes:

* Update the item via the <a href="http://marine.usgs.gov/coastalchangehazardsportal/publish/item/" target="_blank">mediation page</a>
* Delete the tile cache for the application with `deleteTileCache`
* Delete the download cache for the item with `deleteDownload` (rinse and repeat for all parent items)
* Regen the download cache for the item with `downloadItem` (rinse and repeat for all parent items)
* Regen the thumbnail for the item with `refreshItemThumbnail` (rinse and repeat for all parent items)
