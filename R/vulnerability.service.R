#'@title create summary json for an individual vulnerability item
#'@description This service parses the metadata record and creates a summary specific to the 
#'VULNERABILITY theme, with subtype being defined by the attribute name.
#'@param serviceEndpoint valid xml, either local or a url
#'@param attribute an attribute to use form the shapefile corresponding to 
#'\code{serviceEndpoint}
#'@return Serialized JSON for summary
#'@importFrom jsonlite toJSON
#'@import XML
#'@examples
#'serviceEndpoint  <- paste0('https://cida.usgs.gov/coastalhazards/csw/?',
#''service=CSW&request=GetRecordById&version=2.0.2&typeNames=fgdc:metadata',
#''&id=urn:uuid:12d6c1ee-a9e6-11e3-99f6-0050569524e0&',
#''outputSchema=http://www.opengis.net/cat/csw/csdgm&elementSetName=full')
#'attribute <- 'DHIGH'
#'summary <- vulnerability.service(serviceEndpoint,attribute)
#'print(summary)
#'
#'@export
vulnerability.service = function(serviceEndpoint,attribute){
	subType	<-	tolower(attribute)

	subTypeDataSrc <- names(sourceSynonyms)

	doc <- grabXML(serviceEndpoint)

	#title <- xmlValue(getNodeSet(doc,'//crossref/citeinfo/title')[[1]]) # get newest
	if (!is.null(getNodeSet(doc,'//crossref/citeinfo/title')[1][[1]])){
		pubDates	<-	sapply(getNodeSet(doc,'//crossref/citeinfo/title/parent::node()/pubdate'),xmlValue) # only one pub date
		srtI	<-	sort(pubDates,index.return=TRUE,decreasing=TRUE)
		title <- xmlValue(getNodeSet(doc,'//crossref/citeinfo/title')[[srtI$ix[1]]]) # get newest
	} else {
		title	<-	sapply(getNodeSet(doc,'//idinfo/citation/citeinfo/title'),xmlValue)[[1]]# only one pub date
		# is old school
	}
	
	
	purpose <-	xmlValue(getNodeSet(doc,'//descript/purpose')[[1]])
	pIndx	<-	regexpr('. ',purpose, fixed = TRUE)

	abstract	<-	xmlValue(getNodeSet(doc,'//descript/abstract')[[1]])

	overview	<-	paste(c('This datasets includes an element of ', title),collapse='')
	attrDefinition  <- attrDefinitions[subType]
	processDetail	<-	substr(purpose,1,pIndx[1])	# first sentence
	
	sourceString	<-	NULL
	
	medium.summary	<-	paste(c(overview,attrDefinition,processDetail,sourceString),collapse='. ')
	places	<-	sapply(getNodeSet(doc,'//place/placekey'),xmlValue)
	locationContent <-  paste(places,collapse='|')
	location	<-	getLocationString(locationContent,size='tiny',singleVal=TRUE)
	tiny.text	<-	paste(c(titleMap[['tiny']][[subType]],location),collapse=', ')
	
	# create medium title for storm item
	location	<-	getLocationString(locationContent,singleVal=TRUE) # default call is to medium service
	medium.title	<-	paste(c(titleMap[['medium']][[subType]],'for',location),collapse=' ')
	
	full.title	<-	paste(c(titleMap[['full']][[subType]],'for',location),collapse=' ')
	full.text	<-	sub('\n','',paste(c(abstract),collapse=''))
	
	full.publications	<-	getPublications(doc)
	
	keywords	<-	getKeywords (doc,subType)
	
	summaryJSON	<- toJSON(list(
		'version'=as.character(packageVersion(getPackageName())),
		'tiny'=list('text'=tiny.text),
		'medium'=list('title'=medium.title,'text'=medium.summary),
		'legend'=medium.title,
		'full'=list('title'=full.title,'text'=full.text,'publications'=full.publications),
		'keywords'=keywords), auto_unbox = TRUE)
	summaryJSON	<-	sub('NULL. ','',summaryJSON)
	return(summaryJSON)
}